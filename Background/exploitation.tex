\subsection{Exploitation}
\label{exploitation}
Successful exploitation of an \ehi vulnerability depends on where
injection occurs in the SMTP message. The attacker cannot alter parts
of the SMTP message that precede the injection location, but the
attacker has complete control over everything that follows. However,
similar to other command injection vulnerabilities, the remaining
parts of the SMTP message will always be appended to the attacker's
injection, so the attacker must contend with this. By
exploiting an \ehi vulnerability, an attacker can control who receives
the message (and can include multiple \texttt{CC} and \texttt{BCC}
recipients), the body, and possibly the subject (depending on if the subject header occurs
before/after the injection point and the language used).

\begin{lstlisting}[language=HTML,caption={Exploiting the \ehi
      vulnerability in Listing~\ref{code:phpemi} to control the
      recipients, subject, and body of the SMTP message.},label={code:ehiexploit}, float]
Received: from mail.ourdomain.com ([62.121.130.29])
  by xyz.com (Postfix) with ESMTP id 5A08E52C0154
  for <abc@example.com>; Sun, 20 Mar 2016 13:56:58 -0700 (MST)
From: abc@example.com
CC: 1@example.com, 2@example.com, 3@example.com
Subject: My Subject
Content-Type: multipart/mixed; boundary=foobar;
--foobar
Content-Type: text/html

This is the attacker's body
--foobar
To: xyz@example.com
Subject: Hello XYZ
Date: Sun, 20 Mar 2016 13:56:58 -0700(MST)

We need you to reset your password
\end{lstlisting}

The main vector for exploiting \ehi vulnerabilities follows the
template of command injection vulnerability exploitation: first inject
the attacker's desired commands, then comment out the rest of the
message. In \ehi vulnerabilities, the attacker first includes all SMTP
headers she desires. These will typically be the \texttt{Subject}
header to control the subject of the \email\footnotemark, \texttt{CC}
or \texttt{BCC} headers to control the recipients of the \email.

\footnotetext{The SMTP protocol
specifies that there should only be one \texttt{Subject} header, so
the attacker may not be able to alter the subject if the header is
already defined. This behavior would be MUA-dependent.
}

To handle the extra content after the injection point, one technique
is to use a \texttt{Content-type} header to specify that the SMTP
message is a multi-part email and that the sections are separated by
an attacker-specified boundary. The boundary delineates different
parts of the message so that the attacker's body is the only valid
part of the message, and the attacker can choose a random value for
the boundary that is not present in the developer-controlled part of
the SMTP message.

Using this technique, the attacker can completely control the \email.
For instance, injecting the following attack payload:
\texttt{\lstinline{abc@example.com\\nCC:1@example.com, 2@example.com,
    3@example.com\\nSubject: My
    Subject\\nContent-Type:multipart/mixed;
    boundary=foobar;\\n--foobar\\nContent-Type: text/html
    \\n\\nThis is the attacker's body\\n--foobar}} into the \texttt{email} parameter
of the PHP program in Listing~\ref{code:phpemi} results in
the SMTP message shown in Listing~\ref{code:ehiexploit}.

By expanding on this technique, the attacker can include links in the
\email, or even attachments, by adding additional multipart messages
with different content types.

A shorter technique, in case the injection point is limited in input
size, is to use an HTML comment to ignore the developer-controlled
part of the SMTP message, using a payload such as:
\texttt{\lstinline{abc@example.com\\nCC:1@example.com, 2@example.com,
    3@example.com\\nSubject: My Subject\\n
    Content-Type: text/html\\n\\nThis is the attacker's body<!--}}. However, this
technique will only work if the developer-controlled part of the SMTP
message does not contain a closing HTML comment tag
\texttt{\lstinline{-->}}.

